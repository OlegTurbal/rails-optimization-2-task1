# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла серьёзная проблема.

Необходимо было обработать файл с данными, чуть больше ста мегабайт.

У нас уже была программа на `ruby`, которая умела делать нужную обработку.

Она успешно работала на файлах размером пару мегабайт, но для большого файла она работала слишком долго, и не было понятно, закончит ли она вообще работу за какое-то разумное время.

Я решил исправить эту проблему, оптимизировав эту программу.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: realtime в милисекундах.

## Гарантия корректности работы оптимизированной программы
Программа поставлялась с тестом. Выполнение этого теста в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за 1000ms.

Вот как я построил `feedback_loop`: *как вы построили feedback_loop*

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался rbspy, stackprof и ruby_prof для нахождения точек роста. 

Вот какие проблемы удалось найти и решить

### Ваша находка №1
Начал обрабатывать статистику пользователя за один проход

### Ваша находка №2
Удалил не нужные конвертации строки в дату и обратно

### Ваша находка №3
Уменьшил количество вызово map метода для массивов.

### Ваша находка №4
Нашел лишний сплит для данных сесси/пользователя

### Ваша находка №5
Заменил regex на start_with?

### Ваша находка №6
Нашел еще одно место где можно уменьшить колличесто map, путем вынесения дублируюхся вызовов в переменную.

## Результаты
В результате проделанной оптимизации наконец удалось обработать файл с данными.
Удалось улучшить метрику системы с бесконечного, до 51 секунды, но в настоящее время не удалось уложиться в заданный бюджет.

*Какими ещё результами можете поделиться*
1) Не сразу стало понятно с чего начать, очень помогли пояснения на втором уроке.
2) Много времени тратится на перебирание различных методов, вероятно со временем будет яснее, что будет работать быстрее.
3) Было бы очень интересно увидеть живую сессию и ход мыслей (где искать информацию, когда стоит остановитьсь и тд)
4) Остались неиспользуемые переменные и не добавленна волшебная переменная, но по тестам я не вижу, что могу это улушить.

## Защита от регрессии производительности
Написан тест фиксирующий текущую производительность.
